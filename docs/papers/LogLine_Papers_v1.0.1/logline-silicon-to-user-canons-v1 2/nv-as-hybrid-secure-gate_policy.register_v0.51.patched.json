{
  "hash": {
    "alg": "blake3",
    "value": "TO_COMPUTE_AFTER_CANONIZE",
    "algo": "blake3"
  },
  "id": "nv-as-hybrid-secure-gate@0.51",
  "payload": {
    "metadata": {
      "description": "Admission gate determinístico c/ AE (A100-minutes equivalent), pré-verificação, SLA Apple Silicon e budget sem dependências circulares.",
      "name": "nv-as-hybrid-secure-gate",
      "semantic_hash": "blake3:a9f2...32c1"
    },
    "version": "tdln-chip/0.51",
    "yaml": "version: \"tdln-chip/0.51\"\n\nmetadata:\n  name: \"nv-as-hybrid-secure-gate\"\n  description: \"Admission gate determinístico c/ AE (A100-minutes equivalent), pré-verificação, SLA Apple Silicon e budget sem dependências circulares.\"\n  semantic_hash: \"blake3:a9f2...32c1\"\n\nschema:\n  context:\n    user: { id: \"string\", role: \"enum['researcher','admin','student','guest','service']\", tenant_id: \"string\" }\n    request:\n      id: \"string\"\n      project_id: \"string\"\n      purpose: \"enum['training','inference']\"\n      model_family: \"string\"\n      precision: \"enum['fp32','fp16','bf16','int8','int4']\"\n      batch_size: \"integer >= 1\"\n      compute_units_ae: \"number >= 0\"          # A100-minutes equivalent (AE)\n      submitted_at: \"rfc3339\"\n      preferences: { backend_hint: \"enum['nvidia','apple_silicon','cpu','auto']\" }\n      requirements:\n        vram_required_gb: \"number >= 0\"\n        unified_mem_required_gb: \"number >= 0\"\n        ane_required: \"boolean\"\n    project: { id: \"string\", tags: \"array[string]\", max_compute_units_ae: \"number >= 0\" }\n    telemetry:\n      user_jobs_last_1h: \"integer >= 0\"\n      tenant_spend_month_ae: \"number >= 0\"      # acumulado em AE\n      backend:\n        nvidia: { free_gpus: \"integer >= 0\", max_vram_gb: \"number >= 0\", queue_depth: \"integer >= 0\", cold_start_s: \"number >= 0\" }\n        apple_silicon: { free_hosts: \"integer >= 0\", max_unified_mem_gb: \"number >= 0\", ane_available: \"boolean\", queue_depth: \"integer >= 0\", cold_start_s: \"number >= 0\" }\n        cpu: { free_hosts: \"integer >= 0\", queue_depth: \"integer >= 0\", cold_start_s: \"number >= 0\" }\n\nunits:\n  compute_units: \"A100-minutes equivalent (AE)\"\n\ndefaults:\n  project.max_compute_units_ae: 1024\n  limits.jobs_per_hour: 10\n  limits.budget_usd_monthly: 1000\n  planner:\n    mode: \"first_match\"                      # ou 'cheapest_ready'\n    norm_factor:\n      nvidia: 1.00\n      apple_silicon: 0.45\n      cpu: 0.20\n    price_usd_per_AE:\n      nvidia: 1.00\n      apple_silicon: 0.45\n      cpu: 0.20\n    sla:\n      cold_start_max_s:\n        nvidia: 120\n        apple_silicon: 240\n        cpu: 60\n\nlimits:\n  jobs_per_hour: 10\n  budget_usd_monthly: 1000\n  backend:\n    nvidia: { min_vram_gb: 20, max_queue_depth: 200 }\n    apple_silicon: { min_unified_mem_gb: 16, max_queue_depth: 150 }\n    cpu: { max_queue_depth: 100 }\n\npolicies:\n  - id: \"P_GPU_Access\"\n    description: \"Perfis autorizados para aceleração.\"\n    predicate: \"user.role in ['researcher','admin']\"\n    effect: \"permit\"\n    deny_reason: \"role_not_allowed\"\n\n  - id: \"P_Compute_Limit_AE\"\n    description: \"Teto de AE por projeto.\"\n    predicate: \"request.compute_units_ae <= coalesce(project.max_compute_units_ae, defaults.project.max_compute_units_ae)\"\n    effect: \"permit\"\n    deny_reason: \"compute_units_exceeded\"\n\n  - id: \"P_Rate_Limit_1h\"\n    description: \"Rate por usuário.\"\n    predicate: \"coalesce(telemetry.user_jobs_last_1h,0) < coalesce(limits.jobs_per_hour, defaults.limits.jobs_per_hour)\"\n    effect: \"permit\"\n    deny_reason: \"rate_limit_exceeded\"\n\n  - id: \"P_Budget_Ceiling_Month_USD\"\n    description: \"Teto de gasto mensal (conservador; sem dependência de routing/outputs).\"\n    predicate: |\n      let prices = defaults.planner.price_usd_per_AE;\n      let hint = request.preferences.backend_hint;\n      let price_hint = (hint in ['nvidia','apple_silicon','cpu']) ? prices[hint] : null;\n      # Escolha conservadora: usa preço do hint (se válido) SENÃO o maior preço entre backends\n      let unit_price = price_hint != null ? price_hint : max([prices.nvidia, prices.apple_silicon, prices.cpu]);\n      let ae_spent = coalesce(telemetry.tenant_spend_month_ae,0);\n      let ae_new   = request.compute_units_ae;\n      in (ae_spent + ae_new) * unit_price <= coalesce(limits.budget_usd_monthly, defaults.limits.budget_usd_monthly)\n    effect: \"permit\"\n    deny_reason: \"budget_ceiling_exceeded\"\n\nbackend_policies:\n  nvidia:\n    - id: \"PB_NV_Capacity\"\n      predicate: \"coalesce(telemetry.backend.nvidia.free_gpus,0) > 0 and coalesce(telemetry.backend.nvidia.queue_depth,0) <= limits.backend.nvidia.max_queue_depth\"\n      effect: \"permit\"; deny_reason: \"nv_capacity_unavailable\"\n    - id: \"PB_NV_VRAM\"\n      predicate: \"coalesce(telemetry.backend.nvidia.max_vram_gb,0) >= max(coalesce(request.requirements.vram_required_gb,0), limits.backend.nvidia.min_vram_gb)\"\n      effect: \"permit\"; deny_reason: \"nv_insufficient_vram\"\n    - id: \"PB_NV_Precision\"\n      predicate: \"request.precision in ['fp32','fp16','bf16','int8','int4']\"\n      effect: \"permit\"; deny_reason: \"nv_precision_unsupported\"\n    - id: \"PB_NV_ColdStart\"\n      predicate: \"coalesce(telemetry.backend.nvidia.cold_start_s,0) <= defaults.planner.sla.cold_start_max_s.nvidia\"\n      effect: \"permit\"; deny_reason: \"nv_cold_start_exceeds_sla\"\n\n  apple_silicon:\n    - id: \"PB_AS_Capacity\"\n      predicate: \"coalesce(telemetry.backend.apple_silicon.free_hosts,0) > 0 and coalesce(telemetry.backend.apple_silicon.queue_depth,0) <= limits.backend.apple_silicon.max_queue_depth\"\n      effect: \"permit\"; deny_reason: \"as_capacity_unavailable\"\n    - id: \"PB_AS_Memory\"\n      predicate: \"coalesce(telemetry.backend.apple_silicon.max_unified_mem_gb,0) >= max(coalesce(request.requirements.unified_mem_required_gb,0), limits.backend.apple_silicon.min_unified_mem_gb)\"\n      effect: \"permit\"; deny_reason: \"as_insufficient_unified_mem\"\n    - id: \"PB_AS_Precision\"\n      predicate: \"request.precision in ['fp16','bf16','int8','int4']\"\n      effect: \"permit\"; deny_reason: \"as_precision_unsupported\"\n    - id: \"PB_AS_ANE\"\n      predicate: \"coalesce(request.requirements.ane_required,false) == false or coalesce(telemetry.backend.apple_silicon.ane_available,false) == true\"\n      effect: \"permit\"; deny_reason: \"as_ane_required_unavailable\"\n    - id: \"PB_AS_ColdStart\"\n      predicate: \"coalesce(telemetry.backend.apple_silicon.cold_start_s,9999) <= defaults.planner.sla.cold_start_max_s.apple_silicon\"\n      effect: \"permit\"; deny_reason: \"as_cold_start_exceeds_sla\"\n\n  cpu:\n    - id: \"PB_CPU_Capacity\"\n      predicate: \"coalesce(telemetry.backend.cpu.free_hosts,0) > 0 and coalesce(telemetry.backend.cpu.queue_depth,0) <= limits.backend.cpu.max_queue_depth\"\n      effect: \"permit\"; deny_reason: \"cpu_capacity_unavailable\"\n    - id: \"PB_CPU_Purpose\"\n      predicate: \"request.purpose == 'inference' and request.batch_size <= 2\"\n      effect: \"permit\"; deny_reason: \"cpu_not_suited\"\n    - id: \"PB_CPU_ColdStart\"\n      predicate: \"coalesce(telemetry.backend.cpu.cold_start_s,0) <= defaults.planner.sla.cold_start_max_s.cpu\"\n      effect: \"permit\"; deny_reason: \"cpu_cold_start_exceeds_sla\"\n\nrouting:\n  strategy: \"deterministic\"\n  order: [\"nvidia\",\"apple_silicon\",\"cpu\"]\n  honor_backend_hint: true\n  planner:\n    mode: \"${coalesce(defaults.planner.mode,'first_match')}\"\n    norm_factor: \"${defaults.planner.norm_factor}\"\n    price_usd_per_AE: \"${defaults.planner.price_usd_per_AE}\"\n  rules:\n    nvidia:        { require: [\"PB_NV_Capacity\",\"PB_NV_VRAM\",\"PB_NV_Precision\",\"PB_NV_ColdStart\"] }\n    apple_silicon: { require: [\"PB_AS_Capacity\",\"PB_AS_Memory\",\"PB_AS_Precision\",\"PB_AS_ANE\",\"PB_AS_ColdStart\"] }\n    cpu:           { require: [\"PB_CPU_Capacity\",\"PB_CPU_Purpose\",\"PB_CPU_ColdStart\"] }\n\nwiring:\n  algorithm: \"deny_overrides_all_of\"\n  order: [\"P_GPU_Access\",\"P_Compute_Limit_AE\",\"P_Rate_Limit_1h\",\"P_Budget_Ceiling_Month_USD\"]\n  collect: { reasons: true, effective_limits: [\"project.max_compute_units_ae\",\"limits.jobs_per_hour\",\"limits.budget_usd_monthly\"] }\n\noutputs:\n  - name: \"selected_backend\"  ; type: \"string\" ; value: \"${ planner.selected_backend }\"\n\n  - name: \"unit_price_usd\"    ; type: \"number\" ; value: \"${ planner.selected_backend != null ? defaults.planner.price_usd_per_AE[planner.selected_backend] : 0 }\"\n\n  - name: \"norm_factor_applied\"; type: \"number\" ; value: \"${ planner.selected_backend != null ? defaults.planner.norm_factor[planner.selected_backend] : 0 }\"\n\n  - name: \"effective_compute_local\"; type: \"number\" ; value: \"${ request.compute_units_ae * outputs.norm_factor_applied }\"\n\n  - name: \"allow_compute\"     ; type: \"boolean\"; value: \"${ decision.permit and planner.selected_backend != null }\"\n\n  - name: \"decision_code\"     ; type: \"string\" ; value: \"${ outputs.allow_compute ? 'PERMIT' : 'DENY' }\"\n\n  - name: \"deny_reasons\"      ; type: \"array[string]\"; value: \"${ decision.reasons + (planner.selected_backend == null ? ['no_backend_route'] : []) }\"\n\n  - name: \"estimated_job_cost_usd\"; type: \"number\"; value: \"${ outputs.unit_price_usd * request.compute_units_ae }\"\n\n  - name: \"cold_start_estimate_s\"; type: \"number\"; value: \"${ planner.selected_backend != null ? coalesce(telemetry.backend[planner.selected_backend].cold_start_s,0) : 0 }\"\n\n  - name: \"sla_cold_start_max_s\"; type: \"number\"; value: \"${ planner.selected_backend != null ? defaults.planner.sla.cold_start_max_s[planner.selected_backend] : 0 }\"\n\nobligations:\n  - id: \"O_Audit_Span\"\n    when: \"always\"\n    emit:\n      type: \"policy.evaluate\"\n      fields:\n        trace_id: \"${request.id}\"\n        policy_id: \"nv-as-hybrid-secure-gate@0.51\"\n        user_id: \"${user.id}\"\n        tenant_id: \"${user.tenant_id}\"\n        project_id: \"${request.project_id}\"\n        submitted_at: \"${request.submitted_at}\"\n        decision: \"${outputs.decision_code}\"\n        reasons: \"${outputs.deny_reasons}\"\n        selected_backend: \"${outputs.selected_backend}\"\n        compute_units_ae: \"${request.compute_units_ae}\"\n        effective_compute_local: \"${outputs.effective_compute_local}\"\n        estimated_cost_usd: \"${outputs.estimated_job_cost_usd}\"\n",
    "ir": {
      "version": "ir:tdln-intent-graph@0.1",
      "dialect": "intent-graph",
      "constraints": {
        "deterministic": true,
        "pure_function": true,
        "total_semantics": true
      }
    },
    "hal": {
      "profile": "HAL/v0/cpu-gpu",
      "targets_hint": [
        "wasm32",
        "verilog@*",
        "bio@"
      ],
      "timebase_ns": 1,
      "energy_unit": "J",
      "cost_unit": "USD",
      "capabilities": {
        "reads": [
          "slice.health.v1"
        ],
        "writes": [
          "registry.entity"
        ],
        "side_effects": [
          "none"
        ]
      }
    }
  },
  "sig": null,
  "ts": "2026-01-30T00:00:00Z",
  "type": "policy.register"
}